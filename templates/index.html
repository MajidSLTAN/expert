<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¬ Ù†Ø¸Ø§Ù… ØªØ´Ø®ÙŠØµ Ø·Ø¨ÙŠ Ø°ÙƒÙŠ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>ğŸ”¬ Ù†Ø¸Ø§Ù… ØªØ´Ø®ÙŠØµ Ø·Ø¨ÙŠ Ø°ÙƒÙŠ</h1>
    <img src="{{ url_for('static', filename='images/images.jpg') }}" alt="Medical Image" style="width:100%;">

    <form method="POST">
        <label for="input_text">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶:</label>
        <input type="text" id="input_text" name="input_text">
        <button type="submit" name="action" value="diagnose">ØªØ´Ø®ÙŠØµ</button>
        <button type="submit" name="action" value="visualize">ğŸ“ŠØ¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©</button>
    </form>

    <!-- Ø²Ø± Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª -->
    <button id="recordButton">ğŸ¤ ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†</button>
    <p id="status"></p>

    <form method="POST">
        <label for="reverse_search">ğŸ” Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø¶ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¹Ø±Ø§Ø¶Ù‡:</label>
        <input type="text" id="reverse_search" name="reverse_search">
        <button type="submit" name="action" value="reverse_search">ğŸ”„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹ÙƒØ³ÙŠ</button>
    </form>

    {% if disease %}
    <h2>ğŸ¦  Ø§Ù„Ù…Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙ…Ù„: {{ disease }}</h2>
    <p>ğŸ“– Ø§Ù„ÙˆØµÙ: {{ details.get('Ø§Ù„ÙˆØµÙ', '') }}</p>
    <p>ğŸ’Š Ø§Ù„Ø¹Ù„Ø§Ø¬: {{ ', '.join(details.get('Ø§Ù„Ø¹Ù„Ø§Ø¬', [])) }}</p>
    {% endif %}

    {% if graph_html %}
    <h2>ğŸ“Š Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ©</h2>
    <div>{{ graph_html|safe }}</div>
    {% endif %}

    {% if reverse_search %}
    <h2>âœ… Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ {{ reverse_search }}:</h2>
    <p>ğŸ“ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶: {{ ', '.join(symptoms) }}</p>
    {% endif %}

    {% if warning %}
    <p style="color: red;">{{ warning }}</p>
    {% endif %}

    {% if error %}
    <p style="color: red;">{{ error }}</p>
    {% endif %}

    <!-- Ø¥Ø¶Ø§ÙØ© JavaScript Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª -->
    <script>
        const recordButton = document.getElementById('recordButton');
const status = document.getElementById('status');
const inputText = document.getElementById('input_text');

let isRecording = false;
let mediaRecorder;
let audioChunks = [];

if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    status.textContent = "âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.";
    recordButton.disabled = true;
}

recordButton.addEventListener('click', async () => {
    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            mediaRecorder.start();
            isRecording = true;
            recordButton.textContent = "â¹ï¸ Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
            status.textContent = "ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio', audioBlob);

                const response = await fetch('/recognize_speech', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    inputText.value = result.text;
                    status.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ: " + result.text;
                } else {
                    status.textContent = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.";
                }

                audioChunks = [];
                isRecording = false;
                recordButton.textContent = "ğŸ¤ ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†";
            };
        } catch (error) {
            status.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.";
            console.error(error);
        }
    } else {
        mediaRecorder.stop();
    }
});
    </script>
</body>
</html>